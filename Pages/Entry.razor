@page "/entry/{DateStr}"
@using JournalApp.Models
@using JournalApp.Repositories
@using JournalApp.Components
@inject IJournalRepository Repository
@inject NavigationManager Navigation

<div class="page today-page">
    <header class="page-header">
        <div class="header-nav">
            <button class="btn btn-secondary btn-sm" @onclick="GoBack">Back</button>
        </div>
        <h1>@_entryDate.ToString("dddd, MMMM d, yyyy")</h1>
        <p class="page-subtitle">@(_isEditing ? "Edit entry" : "Create entry")</p>
    </header>
    
    @if (_isLoading)
    {
        <div class="loading-state">
            <p>Loading...</p>
        </div>
    }
    else if (_entryDate > DateOnly.FromDateTime(DateTime.Today))
    {
        <div class="empty-state">
            <p>You cannot create entries for future dates.</p>
            <button class="btn btn-primary" @onclick="GoToToday">Go to Today</button>
        </div>
    }
    else
    {
        <div class="editor-container">
            <!-- Entry Form -->
            <div class="entry-form">
                <!-- Title -->
                <div class="form-group">
                    <label for="title">Title</label>
                    <input type="text" 
                           id="title" 
                           @bind="_entry.Title" 
                           @bind:event="oninput"
                           placeholder="What happened this day?"
                           maxlength="200"
                           class="form-input title-input" />
                </div>
                
                <!-- Content Editor -->
                <div class="form-group">
                    <label for="content">
                        Your Journal Entry
                        <span class="word-count">@_wordCount words</span>
                    </label>
                    <JournalApp.Components.EntryEditor 
                        Content="@_entry.Content"
                        OnContentChanged="HandleContentChanged" />
                </div>
                
                <!-- Category -->
                <div class="form-group">
                    <label for="category">Category (Optional)</label>
                    <input type="text" 
                           id="category"
                           @bind="_entry.Category"
                           placeholder="e.g., Personal, Work, Travel"
                           list="categories"
                           class="form-input" />
                    <datalist id="categories">
                        @foreach (var cat in _existingCategories)
                        {
                            <option value="@cat" />
                        }
                    </datalist>
                </div>
            </div>
            
            <!-- Sidebar - Mood & Tags -->
            <div class="entry-sidebar">
                <!-- Mood Picker -->
                <div class="sidebar-section">
                    <h3>How were you feeling?</h3>
                    <JournalApp.Components.MoodPicker 
                        Moods="_moods"
                        PrimaryMoodId="_entry.PrimaryMoodId"
                        SecondaryMood1Id="_entry.SecondaryMood1Id"
                        SecondaryMood2Id="_entry.SecondaryMood2Id"
                        OnMoodsChanged="HandleMoodsChanged" />
                </div>
                
                <!-- Tag Picker -->
                <div class="sidebar-section">
                    <h3>Tags</h3>
                    <JournalApp.Components.TagPicker 
                        Tags="_tags"
                        SelectedTagIds="_selectedTagIds"
                        OnTagsChanged="HandleTagsChanged"
                        OnCreateTag="HandleCreateTag" />
                </div>
                
                <!-- Actions -->
                <div class="sidebar-section actions">
                    <button class="btn btn-primary btn-block" @onclick="SaveEntry" disabled="@_isSaving">
                        @if (_isSaving)
                        {
                            <span>Saving...</span>
                        }
                        else
                        {
                            <span>@(_isEditing ? "Update" : "Save") Entry</span>
                        }
                    </button>
                    
                    @if (_isEditing)
                    {
                        <button class="btn btn-danger btn-block" @onclick="ShowDeleteConfirm">
                            Delete Entry
                        </button>
                    }
                    
                    @if (!string.IsNullOrEmpty(_message))
                    {
                        <div class="message @(_isError ? "error" : "success")">
                            @_message
                        </div>
                    }
                </div>
                
                <!-- Entry Info (if editing) -->
                @if (_isEditing && _entry.Id > 0)
                {
                    <div class="sidebar-section entry-info">
                        <p><small>Created: @_entry.CreatedAt.ToString("g")</small></p>
                        <p><small>Updated: @_entry.UpdatedAt.ToString("g")</small></p>
                    </div>
                }
            </div>
        </div>
        
        <!-- Delete Confirmation Dialog -->
        @if (_showDeleteConfirm)
        {
            <JournalApp.Components.ConfirmDialog 
                Title="Delete Entry"
                Message="Are you sure you want to delete this entry? This action cannot be undone."
                ConfirmText="Delete"
                OnConfirm="DeleteEntry"
                OnCancel="HideDeleteConfirm" />
        }
    }
</div>

@code {
    [Parameter]
    public string DateStr { get; set; } = "";
    
    private DateOnly _entryDate;
    private JournalEntry _entry = new();
    private List<Mood> _moods = new();
    private List<Tag> _tags = new();
    private List<string> _existingCategories = new();
    private List<int> _selectedTagIds = new();
    
    private bool _isLoading = true;
    private bool _isEditing = false;
    private bool _isSaving = false;
    private bool _showDeleteConfirm = false;
    
    private string _message = "";
    private bool _isError = false;
    private int _wordCount = 0;
    
    protected override async Task OnInitializedAsync()
    {
        if (!DateOnly.TryParse(DateStr, out _entryDate))
        {
            _entryDate = DateOnly.FromDateTime(DateTime.Today);
        }
        
        await LoadDataAsync();
    }
    
    private async Task LoadDataAsync()
    {
        _isLoading = true;
        
        try
        {
            _moods = await Repository.GetAllMoodsAsync();
            _tags = await Repository.GetAllTagsAsync();
            _existingCategories = await Repository.GetAllCategoriesAsync();
            
            var existingEntry = await Repository.GetByDateAsync(_entryDate);
            
            if (existingEntry != null)
            {
                _entry = existingEntry;
                _isEditing = true;
                _selectedTagIds = existingEntry.EntryTags.Select(et => et.TagId).ToList();
                UpdateWordCount();
            }
            else
            {
                _entry = new JournalEntry
                {
                    EntryDate = _entryDate,
                    PrimaryMoodId = _moods.FirstOrDefault()?.Id ?? 0
                };
                _selectedTagIds = new List<int>();
            }
        }
        finally
        {
            _isLoading = false;
        }
    }
    
    private void HandleContentChanged(string content)
    {
        _entry.Content = content;
        UpdateWordCount();
    }
    
    private void UpdateWordCount()
    {
        _entry.CalculateWordCount();
        _wordCount = _entry.WordCount;
    }
    
    private void HandleMoodsChanged((int primary, int? secondary1, int? secondary2) moods)
    {
        _entry.PrimaryMoodId = moods.primary;
        _entry.SecondaryMood1Id = moods.secondary1;
        _entry.SecondaryMood2Id = moods.secondary2;
    }
    
    private void HandleTagsChanged(List<int> tagIds)
    {
        _selectedTagIds = tagIds;
    }
    
    private async Task HandleCreateTag(string tagName)
    {
        var newTag = await Repository.CreateTagAsync(new Tag 
        { 
            Name = tagName,
            Color = "#6B7280"
        });
        
        _tags = await Repository.GetAllTagsAsync();
        _selectedTagIds.Add(newTag.Id);
        StateHasChanged();
    }
    
    private async Task SaveEntry()
    {
        if (string.IsNullOrWhiteSpace(_entry.Title))
        {
            ShowMessage("Please enter a title", true);
            return;
        }
        
        if (string.IsNullOrWhiteSpace(_entry.Content))
        {
            ShowMessage("Please write some content", true);
            return;
        }
        
        if (_entry.PrimaryMoodId == 0)
        {
            ShowMessage("Please select a primary mood", true);
            return;
        }
        
        _isSaving = true;
        _message = "";
        
        try
        {
            if (_isEditing)
            {
                await Repository.UpdateAsync(_entry);
            }
            else
            {
                _entry = await Repository.CreateAsync(_entry);
                _isEditing = true;
            }
            
            await Repository.UpdateEntryTagsAsync(_entry.Id, _selectedTagIds);
            _entry = (await Repository.GetByIdAsync(_entry.Id))!;
            
            ShowMessage("Entry saved successfully!", false);
        }
        catch (Exception ex)
        {
            ShowMessage($"Error saving: {ex.Message}", true);
        }
        finally
        {
            _isSaving = false;
        }
    }
    
    private void ShowDeleteConfirm()
    {
        _showDeleteConfirm = true;
    }
    
    private void HideDeleteConfirm()
    {
        _showDeleteConfirm = false;
    }
    
    private async Task DeleteEntry()
    {
        _showDeleteConfirm = false;
        
        try
        {
            await Repository.DeleteAsync(_entry.Id);
            Navigation.NavigateTo($"/calendar?date={_entryDate:yyyy-MM-dd}");
        }
        catch (Exception ex)
        {
            ShowMessage($"Error deleting: {ex.Message}", true);
        }
    }
    
    private void ShowMessage(string message, bool isError)
    {
        _message = message;
        _isError = isError;
        StateHasChanged();
    }
    
    private void GoBack()
    {
        Navigation.NavigateTo($"/calendar?date={_entryDate:yyyy-MM-dd}");
    }
    
    private void GoToToday()
    {
        Navigation.NavigateTo("/today");
    }
}
